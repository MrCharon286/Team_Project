<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<title>Insert title here</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<link rel="stylesheet" href="/css/main.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="/script/main.js"></script>
<style>
	#orders {
		width: 600px; 
	}
	#orders img {
		width : 148px;
	}
</style>
<script>
	let _this = undefined;
	
	const main={
		orders: undefined,
		popup: undefined,
		init: function() {
			$.ajax("/orders/review_available").done(result=>{
				this.orders = result;
				this.printOrders();
			});
			
			$("#section").on("click", ".add_review", this.addReview);
			
			window._this = this;
		},
		
		printOrders:function() {
			const $table = $("<table id='orders'>").appendTo($("#section"));
			$.each(this.orders, function(idx, order) {
				const $tr = $("<tr>").appendTo($table);
				$("<td>").text(order.orderday).appendTo($tr);
				$("<td>").append($("<img>").attr("src", order.image)).appendTo($tr);
				$("<td>").append(order.manufacturer + " " + order.name).appendTo($tr);
				$("<td>").append($("<button>").text("리뷰 작성").attr("class", "add_review").data("order_item_no", order.orderItemNo).data("pno", order.pno)).appendTo($tr);
			});
		},
		
		addReview: function() {
			if(this.popup!=undefined)
				this.popup.close();
			const url = "/review/write_review?orderNo=" + window._this.orders[0].orderNo + "&orderItemNo="+$(this).data("order_item_no");
			this.popup = window.open(url, "_blank", "toolbar=yes, menubar=yes, width=700, height=500");
		}
	};
	
	window.onload = function() {
		main.init();
	}
</script>
</head>
<body>
<div id="page">
	<header id="header" th:replace="/fragments/header">
	</header>
	<nav id="nav" th:replace="/fragments/nav">
	</nav>
	<div id="main">
		<aside th:replace="/fragments/aside">
		</aside>
		<section id="section">
		</section>
	</div>
	<footer id="footer" th:replace="/fragments/footer">
	</footer>
</div>
</body>
</html>