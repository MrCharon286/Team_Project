<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<title>Insert title here</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/product_list.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="/script/main.js"></script>
<script>
	const main = {
		// /products/all 요청을 위한 파라미터 기본값 : pno를 기준으로 내림차순 정렬	
		param : {
			fieldName : "pno",
			isAsc: 0
		},
		
		init: function() {
			$.ajax("/categories/all").done(categories=>this.printCategories(categories));
			$.ajax({url: "/products/all", data:this.param}).done(page=>this.printProducts(page));
		},
		
		printCategories: function(categories) {
			const $ul = $("#menu #ul");
			// 대분류를 출력하면서
			$.each(categories, function(idx, category) {
				const $li = $("<li>").text(category.categoryName).appendTo($ul);
				// 중분류가 존재한다면
				if(category.categories.length>0) {
					const $sub_ul = $("<ul class='main2'>").appendTo($li);
					// 중분류를 출력하면서
					$.each(category.categories, function(idx, sub_category) {
						const $sub_li = $("<li>").text(sub_category.categoryName).appendTo($sub_ul);
						// 소분류가 존재한다면
						if(sub_category.categories.length>0) {
							const $descendant_ul = $("<ul class='main3'>").appendTo($sub_li);
							// 소분류를 출력
							$.each(sub_category.categories, function(idx, descendant_category) {
								$("<li>").data("categoryCode",descendant_category.categoryCode).text(descendant_category.categoryName).css("cursor","pointer").appendTo($descendant_ul);
							});
						}
					});
				}
			});
		},
		
		printProducts: function(page) {
			console.log(page);
			const $row = $("#row");
			$row.empty();
			$.each(page.products, function(idx, product) {
				const $box = $("<div>").attr("class","col-sm-3").appendTo($row);
				// /product/list와의 차이는 아래 라인의 링크가 /admin 쪽으로 걸리는 것 뿐
				const $a = $("<a>").attr("href", "/admin/product/read?pno=" + product.pno).appendTo($box);
				$("<img>").attr("src", product.image).css("width", "175px").appendTo($a);
				const $div = $("<div>").appendTo($box);
				$("<div>").css("font-size","0.75em").text(product.name).appendTo($div);
				$("<div>").css("width","175px").text(product.price+"원").appendTo($div);
				const $star = $("<div>").appendTo($div);
				$("<i>").attr("class", "fa fa-star").css("color","red").appendTo($star);
				$("<span>").text(product.avgOfStar).appendTo($star);
				$("<span>").text("(" + product.reviewCount + ")").appendTo($star);
			});
		}
	}
	
	window.onload = function() {
		main.init();
	}
</script>
</head>
<body>
<div id="page">
	<header id="header" th:replace="/fragments/header">
	</header>
	<nav id="nav" th:replace="/fragments/nav">
	</nav>
	<div id="main">
		<aside th:replace="/fragments/aside">
		</aside>
		<section id="section">
			<div id="menu">
				<ul class="main1" id="ul">
				</ul>
			</div>
			<div id="row" style="margin-top: 200px;">
			</div>
			<hr>
		</section>
	</div>
	<footer id="footer" th:replace="/fragments/footer">
	</footer>
</div>
</body>
</html>